<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<meta name="theme-color" content="#0b1220"/>
<meta name="description" content="PHC Pediatric Dose & Formulary with Saudi Growth Charts - Offline capable medical reference"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="PHC Pediatric"/>
<link rel="manifest" href="#" id="manifest-placeholder"/>
<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAsQAAALEBxi1JjQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAKcSURBVFiFvZdNaBNBGIaf2U2apJu0aZPGNKlNqz8x1R8UQRBB8OBBEDx4UPDgQRAEDx48eBDEk6AHxYMHQfDgQRA8eBDEk4iCB8GDSW2sjW3S/GybNJvd2Rkdkm422WQ3TfvCwu7sMN/zzTczO/MtiAhbGbI1zQDYB+wH9gI1QDWQABaBOeAN8Bp4BkxsRYEtgbcDh4HDwAGgIst7k8Bj4CHwCFjJdLOlBRqBU8ApoKKA9y8DJ4FrQCqdQUIBJ+sFhoBjQGkB75cCx4Gh1Dl6MwksBs5Rgw9CL3AC6AfOu28qKeDXYOODRw3QD5wHYqkXFRJ4b+ODB48a4CvwJvVi2ipoN3DV5u2JEu1/HusArmQS0FLebwEuAp02jxb11R+TIxGNBRlhNWbQ1RCmpjqE4ih2B/gJjE5EmZ2NM/x+ld8xi55D1Rw+WM2uHS4HfuMycBGI+BWoBW4CJ1Ki5y8t0dMd4VCnO9DPny3S25Onu7s33LOzyuLC6hoer6C+LkxvrwftymRiHOgDRjI5kACuA33pFwcHl7hw6Tc+X1bz2ezI0SVaWsqy3utKuF/ghl+BWuA2cDT14szMGmcu/sLnyzpFWfH5hDMXfzEzs5Z+qQq4DdT6FagE7gEHUy9evx1lcNA/QAGGBhcZGPSfgP3AvcRmKTfEV4Ajqdd+fItz7tw0oVDhLg+HNXp6pikunvnkSi1wwatAOXAH6Ei9ODS4yNWrc6yvO3nNt76u0dc3zZ07C+m/dgA3vY14K3AT+Gvher3O+fPT+HyF+fzPZ+P8+Wl0Xc+01A7c8CpQDtwF9qdf1HWdK1d+s7jo5PP3xUWDK1d+o2n+fVBSsK/x1gR1BZ5vADh11a98S42kFrjnPh0+Cvzfkr8BdZ/AhxCklJ0AAAAASUVORK5CYII="/>
<title>PHC Pediatric Dose & Formulary (Saudi Edition)</title>
<style>
  :root{
    --bg:#0b1220; --card:#101b33; --muted:#9fb0d0; --text:#e8eefc; --accent:#4da3ff;
    --good:#16a34a; --warn:#f59e0b; --bad:#ef4444; --line:#213055;
    --chip:#0c1530; --purple:#a855f7; --orange:#fb923c;
    --male:#4da3ff; --female:#ff69b4;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
    -webkit-font-smoothing:antialiased;
    -webkit-tap-highlight-color:transparent;
  }
  header{padding:12px 16px;background:var(--card);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:100}
  h1{margin:0;font-size:18px;font-weight:800;line-height:1.2}
  .subtitle{margin:4px 0 0;color:var(--muted);font-size:11px;line-height:1.4}
  .wrap{padding:12px;max-width:1200px;margin:0 auto;padding-bottom:80px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700;
    background:rgba(77,163,255,.12);border:1px solid rgba(77,163,255,.25);color:var(--accent)}
  .warning-box{
    background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.3);
    border-radius:10px;padding:10px;margin:10px 0;font-size:12px;line-height:1.4
  }
  .warning-box strong{color:#fde68a}
  .alert-box{
    background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);
    border-radius:10px;padding:10px;margin:10px 0;font-size:12px;line-height:1.4
  }
  .alert-box strong{color:#fecaca}
  .info-box{
    background:rgba(77,163,255,.12);border:1px solid rgba(77,163,255,.3);
    border-radius:10px;padding:10px;margin:10px 0;font-size:11px;line-height:1.5
  }
  .info-box strong{color:var(--accent)}
  .success-box{
    background:rgba(22,163,74,.12);border:1px solid rgba(22,163,74,.3);
    border-radius:10px;padding:10px;margin:10px 0;font-size:12px;line-height:1.4
  }
  .success-box strong{color:#86efac}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .field label{display:block;font-size:11px;font-weight:700;color:var(--muted);margin-bottom:6px}
  .field input, .field select{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);
    background:#0c1530;color:var(--text);font-size:15px;transition:.2s
  }
  .field input:focus, .field select:focus{
    outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(77,163,255,.15)
  }
  .field select.male-selected{
    border-color:var(--male);box-shadow:0 0 0 2px rgba(77,163,255,.2)
  }
  .field select.female-selected{
    border-color:var(--female);box-shadow:0 0 0 2px rgba(255,105,180,.2)
  }
  .summary-box{
    background:rgba(77,163,255,.1);border:1px solid rgba(77,163,255,.25);
    border-radius:10px;padding:10px 12px;font-size:13px;font-weight:700
  }
  .summary-box.male-theme{
    background:rgba(77,163,255,.12);border-color:rgba(77,163,255,.3)
  }
  .summary-box.female-theme{
    background:rgba(255,105,180,.12);border-color:rgba(255,105,180,.3)
  }
  .growth-summary{
    background:rgba(22,163,74,.08);border:1px solid rgba(22,163,74,.25);
    border-radius:10px;padding:10px 12px;font-size:12px;margin-top:10px;line-height:1.5
  }
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
  .tab{
    background:rgba(77,163,255,.08);border:1px solid rgba(77,163,255,.2);color:var(--text);
    padding:6px 10px;border-radius:999px;font-size:11px;font-weight:700;cursor:pointer;
    user-select:none;transition:.2s
  }
  .tab.active{background:rgba(77,163,255,.18);border-color:rgba(77,163,255,.35);color:#cfe6ff}
  .tab:hover{background:rgba(77,163,255,.12)}
  .btn{
    background:rgba(77,163,255,.15);border:1px solid rgba(77,163,255,.35);color:#cfe6ff;
    padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;
    transition:.2s;border:none;
  }
  .btn:hover{background:rgba(77,163,255,.25);transform:translateY(-1px)}
  .btn:active{transform:scale(.98)}
  .btn-small{padding:5px 8px;font-size:11px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .search{
    flex:1;min-width:200px;
    padding:10px 12px;border-radius:10px;border:1px solid var(--line);
    background:#0c1530;color:var(--text);font-size:14px
  }
  .search:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(77,163,255,.15)}
  
  .med-card{
    background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:12px;margin:8px 0;
    position:relative;cursor:pointer;transition:.2s
  }
  .med-card:hover{border-color:var(--accent);transform:translateY(-1px)}
  .med-card.expanded{cursor:default;transform:none}
  
  .med-compact{display:block}
  .med-expanded{display:none}
  .med-card.expanded .med-compact{display:none}
  .med-card.expanded .med-expanded{display:block}
  
  .med-header{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .med-name{font-size:14px;font-weight:900;flex:1;line-height:1.3}
  .med-name-full{font-size:15px;font-weight:900;margin-bottom:8px}
  
  .favorite-btn{
    font-size:18px;cursor:pointer;user-select:none;transition:.2s;
  }
  .favorite-btn:hover{transform:scale(1.2)}
  
  .badge{
    font-size:10px;padding:3px 8px;border-radius:10px;display:inline-block;font-weight:800;white-space:nowrap
  }
  .b-good{background:rgba(22,163,74,.18);color:#86efac;border:1px solid rgba(22,163,74,.4)}
  .b-warn{background:rgba(245,158,11,.18);color:#fde68a;border:1px solid rgba(245,158,11,.4)}
  .b-bad{background:rgba(239,68,68,.18);color:#fecaca;border:1px solid rgba(239,68,68,.4)}
  
  .dose-compact{
    font-size:16px;font-weight:900;color:var(--accent);margin:6px 0;
  }
  .dose-display{font-size:18px;font-weight:900;color:var(--accent);margin:8px 0}
  
  .ml-compact{
    font-size:13px;color:#cfe6ff;font-weight:700;margin:4px 0;
  }
  .ml-display{
    font-size:14px;color:#cfe6ff;background:rgba(77,163,255,.15);
    padding:8px 10px;border-radius:8px;display:inline-block;margin:6px 0;font-weight:700
  }
  
  .freq-compact{font-size:11px;color:var(--muted);margin-top:4px}
  .freq{font-size:12px;color:var(--text);background:rgba(77,163,255,.08);padding:5px 8px;border-radius:6px;display:inline-block;margin:6px 0}
  
  .expand-hint{
    font-size:10px;color:var(--muted);text-align:center;margin-top:6px;
    padding:4px;border-top:1px solid var(--line);
  }
  
  .meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .chip{
    font-size:11px;color:var(--muted);border:1px solid var(--line);background:rgba(255,255,255,.03);
    padding:5px 8px;border-radius:999px
  }
  
  .note{color:var(--muted);font-size:11px;line-height:1.5;margin-top:8px;padding:8px;background:rgba(0,0,0,.2);border-radius:6px}
  .note strong{color:#cfe6ff}
  
  .override-input, .conc-select{
    width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--line);
    background:#0c1530;color:var(--text);font-size:14px;margin-top:8px
  }
  .override-input:focus, .conc-select:focus{
    outline:none;border-color:var(--warn);box-shadow:0 0 0 3px rgba(245,158,11,.15)
  }
  
  .small{font-size:10px;color:var(--muted);margin-top:4px}
  
  .ml-calculator{
    background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.2);
    border-radius:8px;padding:10px;margin:8px 0;font-size:11px;
  }
  .ml-calculator strong{color:var(--purple)}
  
  .section-title{
    font-size:11px;font-weight:800;color:var(--accent);margin:12px 0 6px;
    text-transform:uppercase;letter-spacing:0.5px
  }
  
  .collapse-btn{
    width:100%;margin-top:10px;background:rgba(77,163,255,.1);
    border:1px solid rgba(77,163,255,.2);color:var(--accent);
  }
  
  .quick-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
  
  details{margin-top:8px;background:rgba(0,0,0,.2);border-radius:6px;padding:8px}
  details summary{cursor:pointer;font-weight:700;color:#cfe6ff;font-size:11px;padding:4px}
  details[open] summary{margin-bottom:6px}
  details[open]{background:rgba(77,163,255,.05)}
  
  .modal{
    display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center;
  }
  .modal.active{display:flex}
  .modal-content{
    background:var(--card);border:1px solid var(--line);border-radius:16px;
    padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;
  }
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .modal-close{cursor:pointer;font-size:24px;color:var(--muted);line-height:1}
  .modal-close:hover{color:var(--text)}
  
  .history-item{
    background:rgba(77,163,255,.05);border:1px solid var(--line);
    border-radius:8px;padding:10px;margin:8px 0;font-size:11px;
  }
  .history-item strong{color:var(--accent)}
  .history-time{color:var(--muted);font-size:10px}
  
  .install-banner{
    position:fixed;bottom:0;left:0;right:0;
    background:var(--card);border-top:2px solid var(--accent);
    padding:12px 16px;z-index:200;
    transform:translateY(100%);transition:.3s;
    box-shadow:0 -4px 20px rgba(0,0,0,.5)
  }
  .install-banner.show{transform:translateY(0)}
  .install-banner-content{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1200px;margin:0 auto}
  
  footer{
    padding:16px;color:var(--muted);font-size:11px;line-height:1.5;text-align:center;
    border-top:1px solid var(--line);margin-top:20px
  }
  
  @media print{
    body{background:#fff;color:#000}
    .card{border:1px solid #000}
    .btn,.search,.tabs,.modal,.expand-hint,.install-banner{display:none!important}
    .med-card{page-break-inside:avoid}
    .med-compact{display:none!important}
    .med-expanded{display:block!important}
  }
  
  @media (max-width:640px){
    .grid{grid-template-columns:1fr}
    .grid-3{grid-template-columns:1fr}
    h1{font-size:16px}
    .dose-display{font-size:16px}
    .row{gap:8px}
    .install-banner-content{flex-direction:column;align-items:stretch}
  }
</style>
</head>
<body>
<header>
  <h1>üè• PHC Pediatric Dose & Formulary</h1>
  <p class="subtitle">Saudi growth charts ‚Ä¢ Offline PWA ‚Ä¢ Tap meds for details</p>
</header>

<div class="wrap">
  <div class="warning-box">
    <strong>‚ö†Ô∏è For Healthcare Professionals</strong> ‚Ä¢ Always verify against local protocols, check interactions, renal/hepatic adjustments, and maximum daily doses.
  </div>

  <div id="growthAlert"></div>

  <div class="card">
    <div class="grid-3">
      <div class="field">
        <label>Age (years)</label>
        <input id="ageYears" type="number" min="0" max="18" step="1" value="4" inputmode="numeric"/>
      </div>
      <div class="field">
        <label>+ Months</label>
        <input id="ageMonths" type="number" min="0" max="11" step="1" value="0" inputmode="numeric"/>
      </div>
      <div class="field">
        <label>Sex (optional)</label>
        <select id="sex">
          <option value="">Not specified</option>
          <option value="male">üë¶ Male</option>
          <option value="female">üëß Female</option>
        </select>
      </div>
    </div>

    <div class="grid" style="margin-top:10px;">
      <div class="field">
        <label>Weight (kg) *Required</label>
        <input id="weight" type="number" min="0" max="150" step="0.1" value="20" inputmode="decimal"/>
      </div>
      <div class="field">
        <label>Height (cm) - Optional</label>
        <input id="height" type="number" min="0" max="200" step="0.1" value="" inputmode="decimal" placeholder="Optional"/>
      </div>
    </div>

    <div class="summary-box" style="margin-top:12px;" id="ageSummary">‚Äî</div>
    <div id="growthSummary"></div>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:10px;">
      <input class="search" id="searchBox" placeholder="Search medication or indication..."/>
      <div style="display:flex;gap:6px">
        <button class="btn btn-small" id="favoritesBtn">‚≠ê</button>
        <button class="btn btn-small" id="historyBtn">üìã</button>
      </div>
    </div>

    <div class="tabs" id="tabs"></div>

    <div id="doseContainer" style="margin-top:12px;"></div>
  </div>

  <footer id="footerText"></footer>
</div>

<!-- Install Banner -->
<div class="install-banner" id="installBanner">
  <div class="install-banner-content">
    <div>
      <strong>üì± Install App</strong><br>
      <small>Add to home screen for offline access</small>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-small" id="installBtn">Install</button>
      <button class="btn btn-small" id="dismissInstall" style="background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)">Dismiss</button>
    </div>
  </div>
</div>

<!-- History Modal -->
<div class="modal" id="historyModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 style="margin:0;font-size:16px">üìã Calculation History</h2>
      <span class="modal-close" id="closeHistory">√ó</span>
    </div>
    <div id="historyContent"></div>
    <button class="btn" style="width:100%;margin-top:12px" id="clearHistory">Clear History</button>
  </div>
</div>

<!-- Favorites Modal -->
<div class="modal" id="favoritesModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 style="margin:0;font-size:16px">‚≠ê Favorite Medications</h2>
      <span class="modal-close" id="closeFavorites">√ó</span>
    </div>
    <div id="favoritesContent"></div>
  </div>
</div>

<script>
// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(reg => {
      console.log('‚úÖ Service Worker registered:', reg);
    }).catch(err => {
      console.log('‚ùå SW registration failed:', err);
    });
  });
}

// PWA Install Prompt
let deferredPrompt;
const installBanner = document.getElementById('installBanner');
const installBtn = document.getElementById('installBtn');
const dismissInstall = document.getElementById('dismissInstall');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install banner if not dismissed before
  if (!localStorage.getItem('installDismissed')) {
    setTimeout(() => {
      installBanner.classList.add('show');
    }, 2000);
  }
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    console.log('User accepted install');
  }
  
  deferredPrompt = null;
  installBanner.classList.remove('show');
});

dismissInstall.addEventListener('click', () => {
  installBanner.classList.remove('show');
  localStorage.setItem('installDismissed', 'true');
});

// Create dynamic manifest
const manifest = {
  name: "PHC Pediatric Dose & Formulary",
  short_name: "PHC Pediatric",
  description: "Pediatric dosing calculator with Saudi growth charts",
  start_url: ".",
  display: "standalone",
  background_color: "#0b1220",
  theme_color: "#4da3ff",
  orientation: "portrait",
  icons: [
    {
      src: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAsQAAALEBxi1JjQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAKcSURBVFiFvZdNaBNBGIaf2U2apJu0aZPGNKlNqz8x1R8UQRBB8OBBEDx4UPDgQRA8eBDEk6AHxYMHQfDgQRA8eBDEk4iCB8GDSW2sjW3S/GybNJvd2Rkdkm422WQ3TfvCwu7sMN/zzTczO/MtiAhbGbI1zQDYB+wH9gI1QDWQABaBOeAN8Bp4BkxsRYEtgbcDh4HDwAGgIst7k8Bj4CHwCFjJdLOlBRqBU8ApoKKA9y8DJ4FrQCqdQUIBJ+sFhoBjQGkB75cCx4Gh1Dl6MwksBs5Rgw9CL3AC6AfOu28qKeDXYOODRw3QD5wHYqkXFRJ4b+ODB48a4CvwJvVi2ipoN3DV5u2JEu1/HusArmQS0FLebwEuAp02jxb11R+TIxGNBRlhNWbQ1RCmpjqE4ih2B/gJjE5EmZ2NM/x+ld8xi55D1Rw+WM2uHS4HfuMycBGI+BWoBW4CJ1Ki5y8t0dMd4VCnO9DPny3S25Onu7s33LOzyuLC6hoer6C+LkxvrwftymRiHOgDRjI5kACuA33pFwcHl7hw6Tc+X1bz2ezI0SVaWsqy3utKuF/ghl+BWuA2cDT14szMGmcu/sLnyzpFWfH5hDMXfzEzs5Z+qQq4DdT6FagE7gEHUy9evx1lcNA/QAGGBhcZGPSfgP3AvcRmKTfEV4Ajqdd+fItz7tw0oVDhLg+HNXp6pikunvnkSi1wwatAOXAH6Ei9ODS4yNWrc6yvO3nNt76u0dc3zZ07C+m/dgA3vY14K3AT+Gvher3O+fPT+HyF+fzPZ+P8+Wl0Xc+01A7c8CpQDtwF9qdf1HWdK1d+s7jo5PP3xUWDK1d+o2n+fVBSsK/x1gR1BZ5vADh11a98S42kFrjnPh0+Cvzfkr8BdZ/AhxCklJ0AAAAASUVORK5CYII=",
      sizes: "192x192",
      type: "image/png"
    },
    {
      src: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAsQAAALEBxi1JjQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAKcSURBVFiFvZdNaBNBGIaf2U2apJu0aZPGNKlNqz8x1R8UQRBB8OBBEDx4UPDgQRA8eBDEk6AHxYMHQfDgQRA8eBDEk4iCB8GDSW2sjW3S/GybNJvd2Rkdkm422WQ3TfvCwu7sMN/zzTczO/MtiAhbGbI1zQDYB+wH9gI1QDWQABaBOeAN8Bp4BkxsRYEtgbcDh4HDwAGgIst7k8Bj4CHwCFjJdLOlBRqBU8ApoKKA9y8DJ4FrQCqdQUIBJ+sFhoBjQGkB75cCx4Gh1Dl6MwksBs5Rgw9CL3AC6AfOu28qKeDXYOODRw3QD5wHYqkXFRJ4b+ODB48a4CvwJvVi2ipoN3DV5u2JEu1/HusArmQS0FLebwEuAp02jxb11R+TIxGNBRlhNWbQ1RCmpjqE4ih2B/gJjE5EmZ2NM/x+ld8xi55D1Rw+WM2uHS4HfuMycBGI+BWoBW4CJ1Ki5y8t0dMd4VCnO9DPny3S25Onu7s33LOzyuLC6hoer6C+LkxvrwftymRiHOgDRjI5kACuA33pFwcHl7hw6Tc+X1bz2ezI0SVaWsqy3utKuF/ghl+BWuA2cDT14szMGmcu/sLnyzpFWfH5hDMXfzEzs5Z+qQq4DdT6FagE7gEHUy9evx1lcNA/QAGGBhcZGPSfgP3AvcRmKTfEV4Ajqdd+fItz7tw0oVDhLg+HNXp6pigunvnkSi1wwatAOXAH6Ei9ODS4yNWrc6yvO3nNt76u0dc3zZ07C+m/dgA3vY14K3AT+Gvher3O+fPT+HyF+fzPZ+P8+Wl0Xc+01A7c8CpQDtwF9qdf1HWdK1d+s7jo5PP3xUWDK1d+o2n+fVBSsK/x1gR1BZ5vADh11a98S42kFrjnPh0+Cvzfkr8BdZ/AhxCklJ0AAAAASUVORK5CYII=",
      sizes: "512x512",
      type: "image/png"
    }
  ]
};

const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(manifestBlob);
document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

// Saudi Growth Charts Data (from PDFs provided)
const SAUDI_GROWTH = {
  male: {
    wt_0_60: {
      0:{p3:2.5,p10:2.9,p50:3.5,p90:4.1,p97:4.5},
      6:{p3:6.0,p10:6.6,p50:7.8,p90:9.1,p97:9.8},
      12:{p3:7.8,p10:8.6,p50:10.3,p90:12.0,p97:12.9},
      24:{p3:10.0,p10:11.0,p50:13.1,p90:15.3,p97:16.5},
      36:{p3:11.5,p10:12.7,p50:15.2,p90:17.8,p97:19.2},
      48:{p3:13.0,p10:14.3,p50:17.2,p90:20.2,p97:21.8},
      60:{p3:14.5,p10:16.0,p50:19.2,p90:22.6,p97:24.4}
    },
    wt_5_19: {
      72:{p3:16.0,p10:18.0,p50:21.8,p90:26.0,p97:28.2},
      96:{p3:19.2,p10:22.0,p50:27.4,p90:33.5,p97:36.6},
      120:{p3:23.0,p10:26.8,p50:34.2,p90:42.8,p97:47.5},
      144:{p3:28.5,p10:34.0,p50:44.5,p90:57.5,p97:64.5},
      168:{p3:37.5,p10:45.2,p50:59.0,p90:75.5,p97:84.5},
      192:{p3:48.0,p10:57.0,p50:72.5,p90:88.0,p97:96.0},
      216:{p3:55.0,p10:64.0,p50:79.0,p90:93.0,p97:100.5}
    },
    ht_0_60: {
      0:{p3:46,p10:48,p50:50,p90:52,p97:54},
      6:{p3:62,p10:65,p50:69,p90:73,p97:75},
      12:{p3:71,p10:74,p50:79,p90:84,p97:87},
      24:{p3:82,p10:86,p50:93,p90:99,p97:103},
      36:{p3:89,p10:94,p50:101,p90:108,p97:112},
      48:{p3:96,p10:101,p50:109,p90:116,p97:120},
      60:{p3:102,p10:107,p50:115,p90:122,p97:127}
    },
    ht_5_19: {
      72:{p3:108,p10:113,p50:121,p90:129,p97:133},
      96:{p3:118,p10:124,p50:133,p90:142,p97:147},
      120:{p3:129,p10:136,p50:147,p90:157,p97:163},
      144:{p3:143,p10:152,p50:164,p90:175,p97:181},
      168:{p3:160,p10:168,p50:178,p90:187,p97:192},
      192:{p3:168,p10:174,p50:183,p90:191,p97:195},
      216:{p3:170,p10:176,p50:184,p90:191,p97:195}
    }
  },
  female: {
    wt_0_60: {
      0:{p3:2.4,p10:2.8,p50:3.4,p90:4.0,p97:4.4},
      6:{p3:5.5,p10:6.1,p50:7.3,p90:8.6,p97:9.3},
      12:{p3:7.3,p10:8.1,p50:9.7,p90:11.4,p97:12.3},
      24:{p3:9.5,p10:10.5,p50:12.6,p90:14.8,p97:16.0},
      36:{p3:11.0,p10:12.1,p50:14.6,p90:17.2,p97:18.6},
      48:{p3:12.5,p10:13.7,p50:16.5,p90:19.5,p97:21.1},
      60:{p3:14.0,p10:15.3,p50:18.4,p90:21.8,p97:23.6}
    },
    wt_5_19: {
      72:{p3:15.5,p10:17.2,p50:20.9,p90:25.0,p97:27.2},
      96:{p3:18.7,p10:21.3,p50:26.6,p90:32.5,p97:35.8},
      120:{p3:22.8,p10:26.6,p50:34.2,p90:43.0,p97:48.0},
      144:{p3:29.0,p10:34.8,p50:46.0,p90:58.0,p97:64.8},
      168:{p3:38.5,p10:46.2,p50:58.5,p90:69.5,p97:75.0},
      192:{p3:45.5,p10:53.0,p50:64.0,p90:74.0,p97:79.0},
      216:{p3:48.5,p10:55.5,p50:66.5,p90:76.0,p97:81.0}
    },
    ht_0_60: {
      0:{p3:45,p10:47,p50:49,p90:51,p97:53},
      6:{p3:61,p10:64,p50:68,p90:72,p97:74},
      12:{p3:70,p10:73,p50:78,p90:83,p97:86},
      24:{p3:81,p10:85,p50:92,p90:98,p97:102},
      36:{p3:88,p10:93,p50:100,p90:107,p97:111},
      48:{p3:95,p10:100,p50:108,p90:115,p97:119},
      60:{p3:101,p10:106,p50:114,p90:121,p97:126}
    },
    ht_5_19: {
      72:{p3:107,p10:112,p50:120,p90:128,p97:132},
      96:{p3:118,p10:124,p50:133,p90:142,p97:147},
      120:{p3:131,p10:138,p50:149,p90:159,p97:165},
      144:{p3:146,p10:153,p50:164,p90:173,p97:177},
      168:{p3:154,p10:160,p50:169,p90:176,p97:181},
      192:{p3:156,p10:162,p50:170,p90:177,p97:181},
      216:{p3:157,p10:163,p50:171,p90:178,p97:182}
    }
  }
};

const CATEGORIES = ["All","Emergency","Antihistamines","Asthma","ENT","GI","Antibiotics","Pain/Fever","NSAIDs"];

const MEDS = [
  {id:"epi_im",cat:"Emergency",name:"Epinephrine IM",shortName:"Adrenaline IM",common:["1 mg/mL"],indications:"Anaphylaxis IM",contraindications:"None in emergency",method:"epi_mgkg",min_m:0,max_m:216,freq:"q5-15min PRN",notes:"0.01 mg/kg IM (max 0.5 mg)",clinicalTips:"IM anterolateral thigh. Have 2nd dose ready. Monitor rebound. Call EMS.",concentrations:[{label:"1 mg/mL",mg_per_ml:1}]},
  {id:"dex_croup",cat:"Emergency",name:"Dexamethasone",shortName:"Dexamethasone",common:["4 mg/mL inj"],indications:"Croup",contraindications:"Fungal infection",method:"dex_croup",min_m:0,max_m:216,freq:"Single dose",notes:"0.15-0.6 mg/kg (max 10 mg)",clinicalTips:"PO/IM/IV. Lasts 24-72h.",concentrations:[{label:"4 mg/mL",mg_per_ml:4}]},
  {id:"salb_neb",cat:"Asthma",name:"Salbutamol Neb",shortName:"Salbutamol Neb",common:["2.5 mg/2.5 mL"],indications:"Moderate-severe wheeze",contraindications:"Hypersensitivity",method:"mgkg_neb_minmax",min_m:0,max_m:216,freq:"q20min x3",notes:"0.15 mg/kg (min 2.5, max 10 mg)",clinicalTips:"Monitor HR. Reassess after 3 doses."},
  {id:"ipra",cat:"Asthma",name:"Ipratropium",shortName:"Ipratropium",common:["250/500 mcg"],indications:"Severe asthma add-on",contraindications:"Atropine allergy",method:"ipra_neb_age",min_m:0,max_m:216,freq:"q20min x3",notes:"<6y:250mcg; ‚â•6y:500mcg",clinicalTips:"Mix with salbutamol."},
  {id:"pred",cat:"Asthma",name:"Prednisolone",shortName:"Prednisolone",common:["5 mg/5 mL"],indications:"Asthma exacerbation",contraindications:"Fungal infection",method:"pred_mgkg",min_m:0,max_m:216,freq:"Daily x3-5d",notes:"1-2 mg/kg/day (max 40 mg)",clinicalTips:"Give with food. No taper <7 days.",concentrations:[{label:"5 mg/5 mL (1 mg/mL)",mg_per_ml:1}]},
  {id:"montel",cat:"Asthma",name:"Montelukast",shortName:"Montelukast",common:["4/5/10 mg"],indications:"Asthma controller",contraindications:"Hypersensitivity",method:"montelukast_age",min_m:6,max_m:216,freq:"Daily (evening)",notes:"Age-based dosing",clinicalTips:"Bedtime. Counsel re: neuropsych effects."},
  {id:"cetir",cat:"Antihistamines",name:"Cetirizine",shortName:"Cetirizine",common:["5 mg/5 mL"],indications:"Allergic rhinitis",contraindications:"Hypersensitivity",method:"cetirizine_age",min_m:6,max_m:216,freq:"Once daily",notes:"Age-based",clinicalTips:"Less sedating. Adjust in renal impairment.",concentrations:[{label:"5 mg/5 mL (1 mg/mL)",mg_per_ml:1}]},
  {id:"lorat",cat:"Antihistamines",name:"Loratadine",shortName:"Loratadine",common:["5 mg/5 mL"],indications:"Allergic rhinitis",contraindications:"Hypersensitivity",method:"loratadine_age",min_m:24,max_m:216,freq:"Once daily",notes:"2-5y:5mg; ‚â•6y:10mg",clinicalTips:"Non-sedating.",concentrations:[{label:"5 mg/5 mL (1 mg/mL)",mg_per_ml:1}]},
  {id:"chlor",cat:"Antihistamines",name:"Chlorpheniramine",shortName:"Chlorpheniramine",common:["2 mg/5 mL"],indications:"Allergic symptoms",contraindications:"Neonates, MAOI",method:"chlorphen_weight",min_m:24,max_m:216,freq:"q6-8h PRN",notes:"~0.1 mg/kg/dose (max 4 mg)",clinicalTips:"Sedating. Anticholinergic effects.",sideEffects:"Sedation, dry mouth.",concentrations:[{label:"2 mg/5 mL (0.4 mg/mL)",mg_per_ml:0.4}]},
  {id:"mome",cat:"ENT",name:"Mometasone Nasal",shortName:"Mometasone Nasal",common:["50 mcg/spray"],indications:"Allergic rhinitis",contraindications:"Nasal infection",method:"fixed_text",min_m:24,max_m:216,freq:"Daily",fixed:"2-11y:1 spray/nostril; ‚â•12y:2 sprays/nostril",notes:"Intranasal steroid",clinicalTips:"Aim away from septum. Takes days for full effect."},
  {id:"ondans",cat:"GI",name:"Ondansetron",shortName:"Ondansetron",common:["4 mg ODT"],indications:"AGE vomiting",contraindications:"Long QT",method:"ondansetron_AGE_weight",min_m:6,max_m:216,freq:"Single dose",notes:"Wt-based: 8-15kg‚Üí2mg; 15-30kg‚Üí4mg; >30kg‚Üí8mg",clinicalTips:"ODT dissolves on tongue. Encourage rehydration.",concentrations:[{label:"4 mg/5 mL (0.8 mg/mL)",mg_per_ml:0.8}]},
  {id:"omep",cat:"GI",name:"Omeprazole",shortName:"Omeprazole",common:["10/20 mg caps"],indications:"GERD",contraindications:"Hypersensitivity",method:"omeprazole_mgkg",min_m:1,max_m:216,freq:"Once daily",notes:"~1 mg/kg/day (max 40 mg)",clinicalTips:"Before breakfast. Review indication regularly."},
  {id:"lact",cat:"GI",name:"Lactulose",shortName:"Lactulose",common:["10 g/15 mL"],indications:"Constipation",contraindications:"Galactose intolerance",method:"fixed_text",min_m:6,max_m:216,freq:"Daily",fixed:"6m-3y: 5-10 mL daily",notes:"Osmotic laxative",clinicalTips:"Reduce if diarrhea. Takes 24-48h."},
  {id:"amox",cat:"Antibiotics",name:"Amoxicillin",shortName:"Amoxicillin",common:["125/250 mg/5 mL"],indications:"AOM, pharyngitis, pneumonia",contraindications:"PCN allergy",method:"mgkg_single",mgkg:15,min_m:0,max_m:216,max_mg:1000,freq:"q8h",notes:"15 mg/kg/dose",clinicalTips:"Shake well. Refrigerate. Complete course. EBV‚Üírash.",sideEffects:"Diarrhea, rash.",concentrations:[{label:"125 mg/5 mL (25 mg/mL)",mg_per_ml:25},{label:"250 mg/5 mL (50 mg/mL)",mg_per_ml:50}]},
  {id:"amoxclav",cat:"Antibiotics",name:"Co-amoxiclav",shortName:"Co-amoxiclav",common:["125/31 mg/5 mL"],indications:"Sinusitis, bites",contraindications:"PCN allergy, prior jaundice",method:"mgkg_single",mgkg:15,min_m:0,max_m:216,max_mg:875,freq:"q8-12h",notes:"Dose on amox component",clinicalTips:"With food. More diarrhea.",sideEffects:"Diarrhea (common).",concentrations:[{label:"125/31 mg/5 mL (amox 25 mg/mL)",mg_per_ml:25}]},
  {id:"azith",cat:"Antibiotics",name:"Azithromycin",shortName:"Azithromycin",common:["200 mg/5 mL"],indications:"Atypical pneumonia",contraindications:"Macrolide allergy",method:"azithro_5day",min_m:6,max_m:216,max_mg:500,freq:"Daily x5d",notes:"D1:10 mg/kg; D2-5:5 mg/kg",clinicalTips:"QT risk with other QT drugs.",sideEffects:"Diarrhea, QT prolongation.",concentrations:[{label:"200 mg/5 mL (40 mg/mL)",mg_per_ml:40}]},
  {id:"metro",cat:"Antibiotics",name:"Metronidazole",shortName:"Metronidazole",common:["125 mg/5 mL"],indications:"Giardiasis, anaerobes",contraindications:"Hypersensitivity",method:"mgkg_single",mgkg:7.5,min_m:0,max_m:216,max_mg:500,freq:"q8h",notes:"7.5 mg/kg/dose",clinicalTips:"Avoid alcohol 48h. Metallic taste.",sideEffects:"Metallic taste, disulfiram rxn.",concentrations:[{label:"125 mg/5 mL (25 mg/mL)",mg_per_ml:25}]},
  {id:"paracet",cat:"Pain/Fever",name:"Paracetamol",shortName:"Paracetamol",common:["120/160 mg/5 mL"],indications:"Fever, pain",contraindications:"Severe hepatic impairment",method:"mgkg_range",mgkg_low:10,mgkg_high:15,min_m:0,max_m:216,max_mg:1000,maxDailyMgKg:75,freq:"q4-6h PRN (max 4/day)",notes:"10-15 mg/kg/dose. Max 75 mg/kg/day",clinicalTips:"‚ö†Ô∏è Check other products for paracetamol. Overdose‚Üíhepatotoxicity.",sideEffects:"Overdose: liver failure.",concentrations:[{label:"120 mg/5 mL (24 mg/mL)",mg_per_ml:24},{label:"160 mg/5 mL (32 mg/mL)",mg_per_ml:32}]},
  {id:"para_drops",cat:"Pain/Fever",name:"Paracetamol Drops",shortName:"Paracetamol Drops",common:["100 mg/mL"],indications:"Fever, pain (infants)",contraindications:"Severe hepatic impairment",method:"mgkg_range",mgkg_low:10,mgkg_high:15,min_m:0,max_m:216,max_mg:1000,maxDailyMgKg:75,freq:"q4-6h PRN",notes:"‚ö†Ô∏è HIGH CONCENTRATION",clinicalTips:"‚ö†Ô∏è DOSING ERROR RISK! Use calibrated dropper only.",concentrations:[{label:"100 mg/mL drops",mg_per_ml:100}]},
  {id:"ibu",cat:"Pain/Fever",name:"Ibuprofen",shortName:"Ibuprofen",common:["100 mg/5 mL"],indications:"Fever, pain",contraindications:"GI bleed, severe renal impairment, NSAID allergy",method:"mgkg_single",mgkg:10,min_m:6,max_m:216,max_mg:600,maxDailyMgKg:40,freq:"q6-8h PRN",notes:"10 mg/kg/dose. Max 40 mg/kg/day. Avoid <6mo.",clinicalTips:"‚úì Check hydration. With food if upset.",sideEffects:"GI upset, renal impairment.",concentrations:[{label:"100 mg/5 mL (20 mg/mL)",mg_per_ml:20}]},
  {id:"diclo",cat:"NSAIDs",name:"Diclofenac",shortName:"Diclofenac",common:["25/50 mg tabs"],indications:"Inflammatory pain",contraindications:"GI ulcer, NSAID allergy",method:"diclo_mgkg",min_m:6,max_m:216,freq:"BID-TID",notes:"1.5-2.5 mg/kg/day divided",clinicalTips:"With food. Higher GI toxicity.",sideEffects:"GI bleeding, renal issues."}
];

let doseHistory = JSON.parse(localStorage.getItem('doseHistory') || '[]');
let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

function getClosestAge(ageM, data) {
  const ages = Object.keys(data).map(Number).sort((a,b)=>a-b);
  return ages.reduce((prev, curr) => Math.abs(curr - ageM) < Math.abs(prev - ageM) ? curr : prev);
}

function getPercentile(val, pData) {
  if (!pData) return null;
  if (val < pData.p3) return "<3rd";
  if (val < pData.p10) return "3rd-10th";
  if (val < pData.p50) return "10th-50th";
  if (val < pData.p90) return "50th-90th";
  if (val < pData.p97) return "90th-97th";
  return ">97th";
}

function checkGrowth(ageM, wt, ht, sex) {
  if (!sex || !wt || wt <= 0) return null;
  
  const charts = SAUDI_GROWTH[sex];
  if (!charts) return null;
  
  let res = {weight:null, height:null, bmi:null, alerts:[]};
  
  // Weight
  const wtChart = ageM <= 60 ? charts.wt_0_60 : charts.wt_5_19;
  const closestWt = getClosestAge(ageM, wtChart);
  const wtData = wtChart[closestWt];
  
  if (wtData) {
    const perc = getPercentile(wt, wtData);
    res.weight = {value:wt, percentile:perc};
    
    if (wt < wtData.p3) {
      res.alerts.push({type:'danger', msg:`Weight <3rd percentile. Consider growth assessment.`});
    } else if (wt > wtData.p97) {
      res.alerts.push({type:'warning', msg:`Weight >97th percentile. Consider obesity screening if indicated.`});
    } else if (perc.includes("50th")) {
      res.alerts.push({type:'success', msg:`Weight within normal range (${perc} percentile).`});
    }
  }
  
  // Height
  if (ht && ht > 0) {
    const htChart = ageM <= 60 ? charts.ht_0_60 : charts.ht_5_19;
    const closestHt = getClosestAge(ageM, htChart);
    const htData = htChart[closestHt];
    
    if (htData) {
      const htPerc = getPercentile(ht, htData);
      res.height = {value:ht, percentile:htPerc};
      
      if (ht < htData.p3) {
        res.alerts.push({type:'danger', msg:`Height <3rd percentile. Consider evaluation.`});
      } else if (ht > htData.p97) {
        res.alerts.push({type:'info', msg:`Height >97th percentile (tall stature).`});
      }
      
      // BMI
      const htM = ht / 100;
      const bmi = wt / (htM * htM);
      res.bmi = {
        value: bmi.toFixed(1),
        status: bmi < 18.5 ? "Underweight" : bmi < 25 ? "Normal" : bmi < 30 ? "Overweight" : "Obese"
      };
    }
  }
  
  return res;
}

function roundSmart(x){
  if(x===null||x===undefined||isNaN(x)) return "";
  const n = Math.round(x*10)/10;
  return (Math.abs(n) >= 10 || Number.isInteger(n)) ? String(n) : n.toFixed(1);
}

function roundToMeasurable(ml) {
  if (ml < 1) return Math.round(ml * 4) / 4;
  if (ml < 5) return Math.round(ml * 2) / 2;
  return Math.round(ml);
}

function badge(status,label){
  const cls = status==="good" ? "b-good" : status==="bad" ? "b-bad" : "b-warn";
  return `<span class="badge ${cls}">${label}</span>`;
}

function clampMax(mg, maxMg){
  if(!maxMg) return {mg, capped:false};
  if(mg>maxMg) return {mg:maxMg, capped:true};
  return {mg, capped:false};
}

function addToHistory(med, dose, ageM, wt) {
  const entry = {
    timestamp: Date.now(),
    medId: med.id,
    medName: med.shortName || med.name,
    dose: dose.doseText,
    ageMonths: ageM,
    weight: wt
  };
  doseHistory.unshift(entry);
  doseHistory = doseHistory.slice(0, 20);
  localStorage.setItem('doseHistory', JSON.stringify(doseHistory));
}

function toggleFavorite(medId) {
  const idx = favorites.indexOf(medId);
  if (idx > -1) {
    favorites.splice(idx, 1);
  } else {
    favorites.push(medId);
  }
  localStorage.setItem('favorites', JSON.stringify(favorites));
}

function isFavorite(medId) {
  return favorites.includes(medId);
}

function getStoredConcId(medId){
  return localStorage.getItem("conc_"+medId) || "";
}

function setStoredConcId(medId, val){
  localStorage.setItem("conc_"+medId, val);
}

function parseDoseMgRange(doseText){
  if(!doseText) return null;
  const t = String(doseText).replace(/,/g,"").trim();
  if(!t.toLowerCase().includes("mg")) return null;

  let m = t.match(/(\d+(\.\d+)?)\s*[‚Äì-]\s*(\d+(\.\d+)?)\s*mg/i);
  if(m){
    return {lo: Number(m[1]), hi: Number(m[3])};
  }
  m = t.match(/(\d+(\.\d+)?)\s*mg/i);
  if(m){
    const v = Number(m[1]);
    return {lo: v, hi: v};
  }
  return null;
}

function mlFromMg(mg, mgPerMl){
  if(!mgPerMl || mgPerMl<=0) return null;
  return mg / mgPerMl;
}

function formatMlRange(range, mgPerMl){
  const lo = mlFromMg(range.lo, mgPerMl);
  const hi = mlFromMg(range.hi, mgPerMl);
  if(lo===null || hi===null) return "";
  
  const r1 = roundToMeasurable(lo);
  const r2 = roundToMeasurable(hi);
  
  if(Math.abs(r1-r2) < 1e-9) return `${r1} mL`;
  return `${r1}‚Äì${r2} mL`;
}

function calcDose(med, ageM, wtKg, overrideText){
  if(!wtKg || wtKg<=0){
    return {status:"bad", label:"No weight", doseText:"‚Äî"};
  }
  if(wtKg>150){
    return {status:"bad", label:"Invalid", doseText:"Weight too high"};
  }

  if(ageM < med.min_m || ageM > med.max_m){
    return {status:"bad", label:"Not indicated", doseText:"Age not indicated"};
  }

  if(overrideText!=="" && overrideText!==null && !isNaN(Number(overrideText)) && Number(overrideText)>0){
    const mg = Number(overrideText);
    const capMsg = (med.max_mg && mg>med.max_mg) ? ` ‚ö†Ô∏è >max` : "";
    return {status:"warn", label:"Override", doseText:`${roundSmart(mg)} mg${capMsg}`};
  }

  if(med.method==="fixed_text"){
    return {status:"warn", label:"Reference", doseText: med.fixed || "‚Äî"};
  }

  if(med.method==="mgkg_single"){
    let mg = med.mgkg * wtKg;
    const {mg:mg2, capped} = clampMax(mg, med.max_mg);
    mg = mg2;
    return capped
      ? {status:"warn", label:"Max", doseText:`${roundSmart(mg)} mg (max)`}
      : {status:"good", label:"‚úì", doseText:`${roundSmart(mg)} mg`};
  }

  if(med.method==="mgkg_range"){
    let lo = med.mgkg_low * wtKg;
    let hi = med.mgkg_high * wtKg;
    if(med.max_mg){
      lo = Math.min(lo, med.max_mg);
      hi = Math.min(hi, med.max_mg);
    }
    return {status:"good", label:"‚úì", doseText:`${roundSmart(lo)}‚Äì${roundSmart(hi)} mg`};
  }

  if(med.method==="azithro_5day"){
    const d1 = clampMax(10*wtKg, med.max_mg).mg;
    const d2 = clampMax(5*wtKg, 250).mg;
    return {status:"good", label:"‚úì", doseText:`D1: ${roundSmart(d1)} mg ‚Ä¢ D2-5: ${roundSmart(d2)} mg`};
  }

  if(med.method==="mgkg_neb_minmax"){
    let mg = 0.15 * wtKg;
    mg = Math.max(mg, 2.5);
    mg = Math.min(mg, 10);
    return {status:"good", label:"‚úì", doseText:`${roundSmart(mg)} mg`};
  }

  if(med.method==="ipra_neb_age"){
    return {status:"warn", label:"Ref", doseText: ageM < 72 ? "250 mcg" : "500 mcg"};
  }

  if(med.method==="montelukast_age"){
    if(ageM>=6 && ageM<=23) return {status:"good", label:"‚úì", doseText:"4 mg"};
    if(ageM>=24 && ageM<=71) return {status:"good", label:"‚úì", doseText:"4 mg"};
    if(ageM>=72 && ageM<=168) return {status:"good", label:"‚úì", doseText:"5 mg"};
    return {status:"good", label:"‚úì", doseText:"10 mg"};
  }

  if(med.method==="cetirizine_age"){
    if(ageM>=6 && ageM<=23) return {status:"good", label:"‚úì", doseText:"2.5 mg"};
    if(ageM>=24 && ageM<=71) return {status:"good", label:"‚úì", doseText:"2.5‚Äì5 mg"};
    if(ageM>=72 && ageM<=143) return {status:"good", label:"‚úì", doseText:"5‚Äì10 mg"};
    return {status:"good", label:"‚úì", doseText:"10 mg"};
  }

  if(med.method==="loratadine_age"){
    if(ageM>=24 && ageM<=71) return {status:"good", label:"‚úì", doseText:"5 mg"};
    return {status:"good", label:"‚úì", doseText:"10 mg"};
  }

  if(med.method==="chlorphen_weight"){
    let mg = 0.1 * wtKg;
    mg = Math.min(mg, 4);
    return {status:"warn", label:"Caution", doseText:`${roundSmart(mg)} mg`};
  }

  if(med.method==="ondansetron_AGE_weight"){
    if(wtKg < 8) return {status:"warn", label:"Caution", doseText:"0.15 mg/kg (max 8 mg)"};
    if(wtKg>=8 && wtKg<=15) return {status:"good", label:"‚úì", doseText:"2 mg"};
    if(wtKg>15 && wtKg<=30) return {status:"good", label:"‚úì", doseText:"4 mg"};
    return {status:"good", label:"‚úì", doseText:"8 mg"};
  }

  if(med.method==="omeprazole_mgkg"){
    let mg = 1.0 * wtKg;
    mg = Math.min(mg, 40);
    return {status:"warn", label:"Ref", doseText:`${roundSmart(mg)} mg`};
  }

  if(med.method==="diclo_mgkg"){
    const lo = Math.min(1.5*wtKg, 150);
    const hi = Math.min(2.5*wtKg, 150);
    return {status:"warn", label:"Ref", doseText:`${roundSmart(lo)}‚Äì${roundSmart(hi)} mg/day`};
  }

  if(med.method==="epi_mgkg"){
    let mg = 0.01 * wtKg;
    mg = Math.min(mg, 0.5);
    return {status:"good", label:"‚úì", doseText:`${roundSmart(mg)} mg (= ${roundSmart(mg)} mL)`};
  }

  if(med.method==="pred_mgkg"){
    let mg = 1.0 * wtKg;
    mg = Math.min(mg, 40);
    return {status:"warn", label:"Ref", doseText:`${roundSmart(mg)} mg`};
  }

  if(med.method==="dex_croup"){
    const lo = Math.min(0.15*wtKg, 10);
    const hi = Math.min(0.6*wtKg, 10);
    return {status:"warn", label:"Ref", doseText:`${roundSmart(lo)}‚Äì${roundSmart(hi)} mg`};
  }

  return {status:"warn", label:"Ref", doseText:"‚Äî"};
}

function buildTabs(){
  const t = document.getElementById("tabs");
  t.innerHTML="";
  CATEGORIES.forEach(cat=>{
    const div=document.createElement("div");
    div.className="tab"+(cat==="All"?" active":"");
    div.textContent=cat;
    div.dataset.cat=cat;
    div.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      div.classList.add("active");
      render();
    });
    t.appendChild(div);
  });
}

function selectedCategory(){
  const active = document.querySelector(".tab.active");
  return active ? active.dataset.cat : "All";
}

function formatAgeSummary(y,m,ageM,wt){
  let s = `${y}y`;
  if(m>0) s += ` ${m}m`;
  s += ` (${ageM}mo)`;
  if(wt>0) s += ` ‚Ä¢ ${wt.toFixed(1)} kg`;
  return s;
}

function showGrowthAlerts(ageM, wt, ht, sex) {
  const container = document.getElementById("growthAlert");
  const summaryContainer = document.getElementById("growthSummary");
  const sexSelect = document.getElementById("sex");
  const ageSummary = document.getElementById("ageSummary");
  
  // Update sex select styling
  sexSelect.classList.remove('male-selected', 'female-selected');
  if (sex === 'male') {
    sexSelect.classList.add('male-selected');
  } else if (sex === 'female') {
    sexSelect.classList.add('female-selected');
  }
  
  // Update age summary box theme
  ageSummary.classList.remove('male-theme', 'female-theme');
  if (sex === 'male') {
    ageSummary.classList.add('male-theme');
  } else if (sex === 'female') {
    ageSummary.classList.add('female-theme');
  }
  
  if (!sex || !wt || wt <= 0) {
    container.innerHTML = "";
    summaryContainer.innerHTML = "";
    return;
  }
  
  const growth = checkGrowth(ageM, wt, ht, sex);
  
  if (!growth) {
    container.innerHTML = "";
    summaryContainer.innerHTML = "";
    return;
  }
  
  // Display alerts
  let alertsHtml = "";
  growth.alerts.forEach(alert => {
    const boxClass = alert.type === 'danger' ? 'alert-box' : 
                     alert.type === 'warning' ? 'warning-box' :
                     alert.type === 'success' ? 'success-box' : 'info-box';
    const icon = sex === 'male' ? 'üë¶' : 'üëß';
    alertsHtml += `<div class="${boxClass}"><strong>${icon} Saudi Growth Charts:</strong> ${alert.msg}</div>`;
  });
  container.innerHTML = alertsHtml;
  
  // Display growth summary
  let summaryParts = [];
  if (growth.weight) {
    summaryParts.push(`Weight: ${growth.weight.percentile} percentile`);
  }
  if (growth.height) {
    summaryParts.push(`Height: ${growth.height.percentile} percentile`);
  }
  if (growth.bmi) {
    summaryParts.push(`BMI: ${growth.bmi.value} (${growth.bmi.status})`);
  }
  
  if (summaryParts.length > 0) {
    const icon = sex === 'male' ? 'üë¶' : 'üëß';
    summaryContainer.innerHTML = `
      <div class="growth-summary">
        <strong>${icon} Growth Parameters (Saudi Charts 2005):</strong><br>
        ${summaryParts.join(' ‚Ä¢ ')}
      </div>
    `;
  } else {
    summaryContainer.innerHTML = "";
  }
}

function render(){
  const y = Number(document.getElementById("ageYears").value||0);
  const m = Number(document.getElementById("ageMonths").value||0);
  const wt = Number(document.getElementById("weight").value||0);
  const ht = Number(document.getElementById("height").value||0);
  const sex = document.getElementById("sex").value;
  const ageM = y*12 + m;
  
  document.getElementById("ageSummary").textContent = formatAgeSummary(y,m,ageM,wt);
  showGrowthAlerts(ageM, wt, ht, sex);

  const q = (document.getElementById("searchBox").value||"").trim().toLowerCase();
  const cat = selectedCategory();

  let list = MEDS.slice();

  if(cat !== "All") {
    list = list.filter(x=>x.cat===cat);
  }

  if(q){
    list = list.filter(med=>{
      const hay = [
        med.name, med.shortName, med.cat, (med.indications||""), 
        (med.common||[]).join(" "), (med.notes||"")
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  list.sort((a,b)=>a.name.localeCompare(b.name));

  const container = document.getElementById("doseContainer");
  container.innerHTML = "";

  list.forEach(med=>{
    const overrideKey = "ov_" + med.id;
    const overrideVal = localStorage.getItem(overrideKey) ?? "";
    const res = calcDose(med, ageM, wt, overrideVal);

    const card = document.createElement("div");
    card.className="med-card";
    card.dataset.medId = med.id;

    const concList = med.concentrations || [];
    let selectedConcKey = "";
    let mlCompact = "";
    let concHtml = "";
    let mlExpanded = "";
    let mlCalculator = "";

    if(concList.length){
      selectedConcKey = getStoredConcId(med.id) || (concList[0].label || "0");
      if(!concList.some(c => (c.label||"0") === selectedConcKey)){
        selectedConcKey = concList[0].label || "0";
        setStoredConcId(med.id, selectedConcKey);
      }

      const selected = concList.find(c => (c.label||"0") === selectedConcKey) || concList[0];

      if(selected && typeof selected.mg_per_ml === "number"){
        const mgRange = parseDoseMgRange(res.doseText);
        if(mgRange){
          const mlText = formatMlRange(mgRange, selected.mg_per_ml);
          if(mlText) {
            mlCompact = `<div class="ml-compact">üìè ${mlText}</div>`;
            mlExpanded = `<div class="ml-display">üìè Volume: ${mlText}</div>`;
            
            const exact = mlFromMg((mgRange.lo + mgRange.hi)/2, selected.mg_per_ml);
            const rounded = roundToMeasurable(exact);
            mlCalculator = `
              <div class="ml-calculator">
                <strong>üí° Rounding:</strong> ${exact?.toFixed(2)} mL ‚Üí ${rounded} mL<br>
                <small>${((mgRange.lo + mgRange.hi)/2).toFixed(1)} mg √∑ ${selected.mg_per_ml} mg/mL</small>
              </div>
            `;
          }
        }
      }

      if(concList.length > 1) {
        concHtml = `
          <div class="section-title">Concentration</div>
          <select class="conc-select" data-conc-id="${med.id}">
            ${concList.map(c=>{
              const key = c.label || "0";
              const sel = key===selectedConcKey ? "selected" : "";
              return `<option value="${key}" ${sel}>${key}</option>`;
            }).join("")}
          </select>
        `;
      } else if(concList.length === 1) {
        concHtml = `<div class="chip" style="margin-top:8px">${concList[0].label}</div>`;
      }
    }

    const favIcon = isFavorite(med.id) ? "‚≠ê" : "‚òÜ";
    const displayName = med.shortName || med.name;
    
    const compactHtml = `
      <div class="med-header">
        <div class="med-name">${displayName}</div>
        <div style="display:flex;gap:8px;align-items:center">
          ${badge(res.status, res.label)}
          <span class="favorite-btn" data-med-id="${med.id}">${favIcon}</span>
        </div>
      </div>
      <div class="dose-compact">${res.doseText}</div>
      ${mlCompact}
      <div class="freq-compact">${med.freq || "‚Äî"}</div>
      <div class="expand-hint">Tap for details ‚ñº</div>
    `;

    let dailyMaxHtml = "";
    if(med.maxDailyMgKg && wt > 0) {
      const maxDaily = med.maxDailyMgKg * wt;
      dailyMaxHtml = `
        <div class="warning-box">
          <strong>Max Daily:</strong> ${roundSmart(maxDaily)} mg/day (${med.maxDailyMgKg} mg/kg/day)
        </div>
      `;
    }

    const expandedHtml = `
      <div class="med-name-full">${med.name}</div>
      
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        ${badge(res.status, res.label)}
        <span class="favorite-btn" data-med-id="${med.id}">${favIcon}</span>
      </div>

      <div class="dose-display">${res.doseText}</div>
      ${mlExpanded}
      ${mlCalculator}
      <div class="freq">${med.freq || "‚Äî"}</div>

      ${dailyMaxHtml}

      ${concHtml}

      <div class="section-title">Manual Override (mg)</div>
      <input class="override-input" inputmode="decimal" placeholder="Leave empty for auto-calculation"
        value="${overrideVal}" data-med-id="${med.id}" />
      <div class="small">Saved on this device only</div>

      ${med.clinicalTips ? `
        <div class="info-box" style="margin-top:10px">
          <strong>üí° Clinical Tip:</strong> ${med.clinicalTips}
        </div>
      ` : ""}

      <details>
        <summary>üìã Indication & Contraindications</summary>
        <div class="note">
          <strong>Indication:</strong> ${med.indications || "‚Äî"}<br><br>
          <strong>Contraindications:</strong> ${med.contraindications || "‚Äî"}
        </div>
      </details>

      ${med.sideEffects ? `
        <details>
          <summary>‚ö†Ô∏è Side Effects</summary>
          <div class="note">${med.sideEffects}</div>
        </details>
      ` : ""}

      <details>
        <summary>üßÆ mL Calculation Formula</summary>
        <div class="note">
          <strong>mL = Dose (mg) √∑ Concentration (mg/mL)</strong><br>
          Example: 200 mg needed, syrup 20 mg/mL ‚Üí 200 √∑ 20 = 10 mL<br>
          Round to measurable volume on your syringe.
        </div>
      </details>

      <div class="quick-actions">
        <button class="btn btn-small add-history-btn" data-med-id="${med.id}">üìã Add to History</button>
      </div>

      <button class="btn collapse-btn">‚ñ≤ Collapse</button>
    `;

    card.innerHTML = `
      <div class="med-compact">${compactHtml}</div>
      <div class="med-expanded">${expandedHtml}</div>
    `;

    card.addEventListener("click", (e)=>{
      if(e.target.closest('.favorite-btn') || 
         e.target.closest('.add-history-btn') ||
         e.target.closest('.override-input') ||
         e.target.closest('.conc-select') ||
         e.target.closest('.collapse-btn') ||
         e.target.closest('details')) {
        return;
      }
      
      if(!card.classList.contains('expanded')) {
        card.classList.add('expanded');
      }
    });

    const collapseBtn = card.querySelector('.collapse-btn');
    collapseBtn?.addEventListener('click', (e)=>{
      e.stopPropagation();
      card.classList.remove('expanded');
      card.scrollIntoView({behavior: 'smooth', block: 'nearest'});
    });

    card.querySelectorAll('.favorite-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute('data-med-id');
        toggleFavorite(id);
        render();
      });
    });

    const input = card.querySelector('.override-input');
    input?.addEventListener('input', (e)=>{
      localStorage.setItem(overrideKey, e.target.value);
      render();
    });

    const histBtn = card.querySelector('.add-history-btn');
    histBtn?.addEventListener('click', (e)=>{
      e.stopPropagation();
      const id = e.target.getAttribute('data-med-id');
      const m = MEDS.find(x => x.id === id);
      if(m && res.doseText !== "‚Äî") {
        addToHistory(m, res, ageM, wt);
        e.target.textContent = "‚úì Added";
        setTimeout(()=>{ e.target.textContent = "üìã Add to History"; }, 2000);
      }
    });

    const concSel = card.querySelector('.conc-select');
    concSel?.addEventListener('change', (e)=>{
      e.stopPropagation();
      const medId = e.target.getAttribute('data-conc-id');
      setStoredConcId(medId, e.target.value);
      render();
    });

    container.appendChild(card);
  });

  if(list.length===0){
    const empty = document.createElement("div");
    empty.className="warning-box";
    empty.innerHTML = "<strong>No matches.</strong> Try different search or category.";
    container.appendChild(empty);
  }

  document.getElementById("footerText").innerHTML = `
    <strong>Saudi Edition PWA by Aljarrah</strong><br>
    Saudi Growth Charts (El Mouzan 2005) ‚Ä¢ Lexicomp ‚Ä¢ BNFC<br>
    <small>Install as app for offline access</small>
  `;
}

function showHistory() {
  const modal = document.getElementById("historyModal");
  const content = document.getElementById("historyContent");
  
  if(doseHistory.length === 0) {
    content.innerHTML = '<div class="info-box">No calculations yet.</div>';
  } else {
    content.innerHTML = doseHistory.map(entry => {
      const date = new Date(entry.timestamp);
      return `
        <div class="history-item">
          <strong>${entry.medName}</strong><br>
          ${entry.dose} ‚Ä¢ ${entry.ageMonths}mo ‚Ä¢ ${entry.weight}kg<br>
          <span class="history-time">${date.toLocaleString()}</span>
        </div>
      `;
    }).join('');
  }
  
  modal.classList.add('active');
}

function showFavorites() {
  const modal = document.getElementById("favoritesModal");
  const content = document.getElementById("favoritesContent");
  
  if(favorites.length === 0) {
    content.innerHTML = '<div class="info-box">No favorites. Tap ‚òÜ on medications.</div>';
  } else {
    const favMeds = MEDS.filter(m => favorites.includes(m.id));
    content.innerHTML = favMeds.map(med => `
      <div class="history-item" style="cursor:pointer" onclick="document.getElementById('searchBox').value='${med.shortName||med.name}';document.getElementById('closeFavorites').click();render()">
        <strong>${med.shortName || med.name}</strong><br>
        <small>${med.cat}</small>
      </div>
    `).join('');
  }
  
  modal.classList.add('active');
}

buildTabs();
document.getElementById("ageYears").addEventListener("input", render);
document.getElementById("ageMonths").addEventListener("input", render);
document.getElementById("weight").addEventListener("input", render);
document.getElementById("height").addEventListener("input", render);
document.getElementById("sex").addEventListener("change", render);
document.getElementById("searchBox").addEventListener("input", render);

document.getElementById("historyBtn").addEventListener("click", showHistory);
document.getElementById("favoritesBtn").addEventListener("click", showFavorites);

document.getElementById("closeHistory").addEventListener("click", ()=>{
  document.getElementById("historyModal").classList.remove('active');
});

document.getElementById("closeFavorites").addEventListener("click", ()=>{
  document.getElementById("favoritesModal").classList.remove('active');
});

document.getElementById("clearHistory").addEventListener("click", ()=>{
  if(confirm("Clear all history?")) {
    doseHistory = [];
    localStorage.setItem('doseHistory', '[]');
    showHistory();
  }
});

document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if(e.target === modal) modal.classList.remove('active');
  });
});

render();
</script>
</body>
</html>
